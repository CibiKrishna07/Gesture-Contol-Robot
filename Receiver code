#include <esp_now.h>
#include <WiFi.h>

// Motor control pins
#define AIN1 27
#define AIN2 26
#define BIN1 19
#define BIN2 18
#define STBY 33
#define PWMA 25
#define PWMB 5

// --------- Updated Structure to match sender ---------
typedef struct struct_message {
  float angle_x;  // forward/backward tilt
  float angle_y;  // left/right tilt
} struct_message;

struct_message myData;

// ------------ Motor Functions ------------
void moveForward() {
  digitalWrite(AIN1, HIGH); digitalWrite(AIN2, LOW);
  digitalWrite(BIN1, HIGH); digitalWrite(BIN2, LOW);
  digitalWrite(PWMA, HIGH); digitalWrite(PWMB, HIGH);
}

void moveBackward() {
  digitalWrite(AIN1, LOW); digitalWrite(AIN2, HIGH);
  digitalWrite(BIN1, LOW); digitalWrite(BIN2, HIGH);
  digitalWrite(PWMA, HIGH); digitalWrite(PWMB, HIGH);
}

void moveRight() {
  digitalWrite(AIN1, LOW); digitalWrite(AIN2, HIGH);
  digitalWrite(BIN1, LOW); digitalWrite(BIN2, HIGH);
  analogWrite(PWMA, 255); analogWrite(PWMB, 170);
}

void moveLeft() {
  digitalWrite(AIN1, LOW); digitalWrite(AIN2, HIGH);
  digitalWrite(BIN1, LOW); digitalWrite(BIN2, HIGH);
  analogWrite(PWMA, 170); analogWrite(PWMB, 255);
}

void stopMotors() {
  digitalWrite(AIN1, LOW); digitalWrite(AIN2, LOW);
  digitalWrite(BIN1, LOW); digitalWrite(BIN2, LOW);
  digitalWrite(PWMA, LOW); digitalWrite(PWMB, LOW);
}

// ------------ ESP-NOW Receive Callback ------------
void OnDataRecv(const esp_now_recv_info_t *info, const uint8_t *incomingData, int len) {
  memcpy(&myData, incomingData, sizeof(myData));

  Serial.print("Angle X: "); Serial.print(myData.angle_x);
  Serial.print("  Angle Y: "); Serial.println(myData.angle_y);

  // Control logic based on tilt angles
  if (myData.angle_x > 15) {
    moveForward();
  } else if (myData.angle_x < -15) {
    moveBackward();
  } else if (myData.angle_y > 15) {
    moveLeft();
  } else if (myData.angle_y < -15) {
    moveRight();
  } else {
    stopMotors();
  }
}

void setup() {
  Serial.begin(115200);

  pinMode(AIN1, OUTPUT); pinMode(AIN2, OUTPUT);
  pinMode(BIN1, OUTPUT); pinMode(BIN2, OUTPUT);
  pinMode(STBY, OUTPUT);
  pinMode(PWMA, OUTPUT); pinMode(PWMB, OUTPUT);
  digitalWrite(STBY, HIGH);
  stopMotors();

  WiFi.mode(WIFI_STA);
  WiFi.disconnect();

  if (esp_now_init() != ESP_OK) {
    Serial.println("Error initializing ESP-NOW");
    return;
  }

  esp_now_register_recv_cb(OnDataRecv);
}

void loop() {
  // Empty. Handled by callback.
}
